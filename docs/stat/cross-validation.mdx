# 교차 검증

## 교차 검증 (Cross Validation, CV)

*   **목적:** 모형의 **일반화 성능 (새로운 데이터 예측 성능)** 평가 방법.
*   **원리:** 데이터를 **훈련(train)셋**과 **테스트(test)셋**으로 분할. 훈련셋으로 모형 학습 후, **별개 테스트셋**으로 예측 성능 검증.
*   **장점:** 수정R²/AIC/BIC 등 이론적 보정보다 **과적합 더 현실적으로 반영 가능**. 이론적 가정 불필요. 데이터 충분 시 권장.
*   **단점:** 데이터 분할 필요. 계산 비용 증가.

## 교차 검증 종류

*   **데이터 분할/활용 방식** 따라 여러 종류 존재.
    *   **LpO CV (Leave-p-out):** p개 제외한 데이터로 학습, p개로 테스트. 모든 조합 시도 (현실적으로 어려움).
    *   **LOOCV (Leave-one-out):** 1개 제외한 데이터로 학습, 1개로 테스트. N번 반복 (N=데이터 개수).
    *   **k-fold CV:** 데이터 k개 묶음(fold) 분할. k-1개로 학습, 1개로 테스트. k번 반복하며 테스트셋 변경. 가장 널리 사용.
    *   **Holdout:** 데이터 한 번만 훈련/테스트셋 분할하여 1회 검증. 가장 간단.

## 교차 검증 결과 해석

| 훈련 오차 | 테스트 오차 | 상태        | 조치                |
| :-------- | :---------- | :---------- | :------------------ |
| 높음      | 높음        | **과소적합** (Underfitting) | 모형 복잡하게 수정  |
| 낮음      | 낮음        | **적절**    | 바람직              |
| 낮음      | 높음        | **과적합** (Overfitting)  | 모형 단순하게 수정  |

## Python 교차 검증 코드 (Holdout 예시)

```python
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_squared_error

# 1. 데이터 분할 (80% 훈련, 20% 테스트)
train_df, test_df = train_test_split(
    df,               # 원본 데이터
    test_size=0.2,    # 테스트 데이터 비율
    random_state=42   # 난수 시드 고정 (재현성 위함)
)

# 2. 훈련 데이터로 모형 학습
m = ols('price ~ year', data=train_df).fit()

# 3. 테스트 데이터로 예측
y_pred = m.predict(test_df)

# 4. 테스트 데이터 예측 오차(MSE) 계산
mean_squared_error(test_df.price, y_pred)
```

## 전진 선택

```python
depvar = 'price'
features = ['year', 'mileage', 'model', 'my_car_damage', 'other_car_damage']
included = []

threshold = 0.01
changed = True
best_formula = depvar + ' ~ 1'  # 절편만 있는 모형
best_model = ols(best_formula, data=train_df).fit()
best_mse = mean_squared_error(test_df[depvar], best_model.predict(test_df))
print(f'{best_formula} (MSE: {best_mse})')  # 절편만 있는 모형 출력

while changed:
    excluded = list(set(features) - set(included))
    best_feature = None
    for new_column in excluded:
        formula = depvar + ' ~ ' + ' + '.join(included + [new_column])
        model = ols(formula, data=train_df).fit()
        mse = mean_squared_error(test_df[depvar], model.predict(test_df))
        if mse < best_mse - threshold:
            best_feature = new_column
            best_mse = mse
            best_model = model
            best_formula = formula
    changed = best_feature is not None
    if changed:
        included.append(best_feature)
        print(f'{best_formula} (MSE: {best_mse})')
best_model.summary()  # 최종 모형 요약 출력        
```

## 후진 선택

```python
depvar = 'price'
features = ['year', 'mileage', 'model', 'my_car_damage', 'other_car_damage']
included = features.copy()
threshold = 0.01
changed = True
best_formula = depvar + ' ~ ' + ' + '.join(included)  # 초기 모형
best_model = ols(best_formula, data=train_df).fit()
best_mse = mean_squared_error(test_df[depvar], best_model.predict(test_df))
print(f'{best_formula} (MSE: {best_mse})')  # 초기 모형 출력
while changed:
    excluded = list(set(features) - set(included))
    best_feature = None
    for remove_feature in included:
        formula = depvar + ' ~ ' + ' + '.join(list(set(included) - set([remove_feature])))
        model = ols(formula, data=train_df).fit()
        mse = mean_squared_error(test_df[depvar], model.predict(test_df))
        if mse < best_mse - threshold:
            best_feature = remove_feature
            best_model = model
            best_mse = mse
            best_formula = formula
    changed = best_feature is not None
    if changed:
        included.remove(best_feature)
        print(f'{best_formula} (MSE: {best_mse})')
best_model.summary()  # 최종 모형 요약 출력        
```


## 퀴즈

import { QuizComponent } from "@/components/QuizComponent";

<QuizComponent quizId="cross-validation" quizItems={
[
    {
        "item_type": "radio",
        "question": "교차 검증(Cross Validation)을 수행하는 주된 목적은 무엇인가요?",
        "options": [
            "회귀계수의 신뢰구간을 더 좁게 추정하기 위해",
            "독립변수들 간의 다중공선성 문제를 해결하기 위해",
            "모형이 새로운 데이터에 대해 얼마나 잘 예측할지(일반화 성능)를 평가하기 위해",
            "종속변수의 분포를 정규분포에 가깝게 변환하기 위해"
        ],
        "hint": "교차 검증은 추정된 모형을 새로운 데이터에 적용하여 예측 성능을 평가하는 방법입니다.",
        "solution": "모형이 새로운 데이터에 대해 얼마나 잘 예측할지(일반화 성능)를 평가하기 위해",
    },
    {
        "item_type": "radio",
        "question": "데이터를 같은 크기의 여러 부분으로 나누어, 각 부분을 한 번씩 테스트셋으로 사용하고 나머지를 훈련셋으로 사용하는 교차 검증 방법은 무엇인가요?",
        "options": [
            "Holdout 교차 검증",
            "Leave-One-Out 교차 검증 (LOOCV)",
            "k-폴드 교차 검증 (k-fold CV)",
            "Leave-p-Out 교차 검증 (LpO CV)"
        ],
        "hint": "k-폴드 교차 검증은 데이터를 k개의 부분으로 나누어, 각 부분을 한 번씩 테스트셋으로 사용하는 방법입니다.",
        "solution": "k-폴드 교차 검증 (k-fold CV)"
    },
    {
        "item_type": "radio",
        "question": "교차 검증 결과, 훈련 데이터에 대한 오차는 매우 낮았지만 테스트 데이터에 대한 오차는 매우 높게 나왔습니다. 이 모형의 상태를 가장 잘 설명하는 것은 무엇인가요?",
        "options": [
            "과소적합 (Underfitting) 상태이며, 모형을 더 복잡하게 만들어야 한다.",
            "과대적합 (Overfitting) 상태이며, 모형을 더 단순하게 만들어야 한다.",
            "적절한 상태이며, 이 모형을 사용하는 것이 바람직하다.",
            "훈련 데이터와 테스트 데이터가 잘못 분리되었으므로 데이터를 다시 분할해야 한다.",
        ],
        "hint": "훈련 데이터에 대한 오차가 낮고 테스트 데이터에 대한 오차가 높다는 것은 모형이 훈련 데이터에 너무 과하게 적합되어 새로운 데이터에 대한 예측 성능이 떨어지는 과대적합 상태를 의미합니다.",
        "solution": "과대적합 (Overfitting) 상태이며, 모형을 더 단순하게 만들어야 한다."
    },
    {
        "item_type": "checkbox",
        "question": "call_center.xlsx 에서 sales를 종속변수로 회귀분석을 수행하세요. 교차 검증과 전진선택을 통해 모형을 선택하세요. 이때 전진선택에서 추가된 변수들을 **모두** 고르세요",
        "options": [
            "kind",
            "active",
            "talk",
            "career",
            "gender"
        ],
        "hint": "```\nimport pandas as pd\nimport varsel\nfrom sklearn.model_selection import train_test_split\ncc = pd.read_excel(\'call_center.xlsx\')\n\ntrain_df, test_df = train_test_split(\n    cc,               # 원본 데이터\n    test_size=0.2,    # 테스트 데이터 비율\n    random_state=42   # 난수 시드 고정 (재현성 위함)\n)\nm = varsel.forward_selection_with_cv(\'sales ~ kind + active + talk + career + gender\', train_df, test_df)\nm.summary()\n```",
        "solution": [
            "active",
            "talk",
        ],
    },
    {
        "item_type": "number",
        "question": "위에서 선택된 모형의 테스트 MSE는 얼마입니까? (소수점 둘째 자리까지)",
        "tolerance": 0.01,
        "hint": "위의 문제 힌트 참고",
        "solution": 388.0131371861462
    },
    {
        "item_type": "radio",
        "question": "call_center.xlsx 에서 sales를 종속변수로 회귀분석을 수행하세요. 교차 검증과 후진선택을 통해 모형을 선택하세요. 이때 **제일 먼저** 제거된 독립변수를 고르세요",
        "options": [
            "kind",
            "active",
            "talk",
            "career",
            "gender"
        ],
        "hint": "```\nm = varsel.backward_selection_with_cv(\'sales ~ kind + active + talk + career + gender\', train_df, test_df)\nm.summary()\n```",
        "solution": "kind"
    }
]
} />

## Q&A
<iframe src="https://tally.so/embed/wbOOKg?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=0" loading="lazy" width="100%" height="274" frameborder="0" marginheight="0" marginwidth="0" title="Q&A"></iframe>